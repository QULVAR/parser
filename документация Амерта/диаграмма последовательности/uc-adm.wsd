@startuml
title Диаграмма последовательности: Администратор
actor Администратор as Admin
participant "UI (МП)" as UI
participant "Сервис валидации" as ValidationService
participant "Промокод сервис" as PromoService
participant "Файловый сервис" as FileService
participant "Сервис каталога" as CatalogService
participant "Сервис пользователей" as UserService
participant "База данных" as DB

== Импорт каталога ==

Admin -> UI: Находиться в личном кабинете и нажимает на кнопку админ-панели
UI -> Admin: Открывает админ панель
Admin -> UI: Нажимает кнопку импорта каталога
UI -> Admin: Открывает диалог выбора файла

Admin -> UI: Выбирает и загружает файл
UI -> FileService: Передаёт файл для обработки

FileService -> FileService: Проверяет формат и структуру файла
alt Некорректный формат файла (ERR-05)
    FileService -> UI: Возвращает ошибку "Некорректный формат файла"
    UI -> Admin: Отображает сообщение об ошибке
    UI -> UI: Данные каталога не изменяются
else Формат корректен
    FileService -> CatalogService: Передаёт данные для импорта
    CatalogService -> DB: Запрос на сохранение нового каталога
    
    alt Ошибка сервера (ERR-01)
        DB -> CatalogService: Возвращает ошибку соединения/сервера
        CatalogService -> UI: "Внутренняя ошибка сервиса. Попробуйте позже"
        UI -> Admin: Отображает сообщение об ошибке
        UI -> UI: Данные каталога не изменяются
    else Успешное сохранение
        DB -> CatalogService: Подтверждение успешного сохранения
        CatalogService -> UI: Успешный ответ об обновлении
        UI -> Admin: Отображает уведомление об успешном обновлении каталога
    end
end

== Создание пользователя ==

Admin -> UI: Нажимает кнопку создания пользователя
UI -> Admin:  Создает новую строку в таблицу

Admin -> UI: Вводит логин и пароль
UI -> ValidationService: Валидирует формат данных
alt Валидация не пройдена (ERR-02)
    ValidationService -> UI: Возвращает ошибки валидации
    UI -> Admin: Подсвечивает поля с ошибками\nи показывает сообщение
    UI -> Admin: Кнопка "Сохранить" остаётся некликабельной
else Валидация пройдена
    UI -> Admin: Кнопка "Сохранить" становится кликабельной
    Admin -> UI: Нажимает кнопку "Сохранить"
    UI -> UserService: Запрос на создание пользователя\n(данные + проверка уникальности)
    
    UserService -> DB: Проверка существования пользователя с таким email
    alt Пользователь уже существует (ERR-03)
        DB -> UserService: Возвращает информацию о существующем пользователе
        UserService -> UI: "Пользователь с таким логином уже существует"
        UI -> Admin: Отображает сообщение об ошибке
    else Пользователь уникален
        UserService -> UserService: Хэширование пароля
        UserService -> DB: Сохраняет нового пользователя
        DB -> UserService: Подтверждение успешного создания
        UserService -> UI: Успешный ответ
        UI -> Admin: Отображает уведомление об успешном создании пользователя
    end
    
    alt Ошибка сервера (ERR-01) на любом этапе
        UI -> Admin: "Внутренняя ошибка сервиса. Попробуйте позже"
        UI -> UI: Сохраняет введённые данные в форме
    end
end

== Удаление пользователя ==

Admin -> UI: Нажимает кнопку удаления пользователя\n(рядом с конкретным пользователем)
UI -> UserService: Запрос на удаление пользователя

UserService -> DB: Удаляет пользователя и связанные данные
alt Ошибка сервера (ERR-01)
    DB -> UserService: Возвращает ошибку
    UserService -> UI: "Внутренняя ошибка сервиса. Попробуйте позже"
    UI -> Admin: Отображает сообщение об ошибке
else Успешное удаление
    DB -> UserService: Подтверждение удаления
    UserService -> UI: Успешный ответ
    UI -> Admin: Отображает уведомление об успешном удалении пользователя
end

== Создание промокода ==

Admin -> UI: Нажимает кнопку создания промокода
UI -> Admin:  Создает новую строку в таблицу

Admin -> UI: Вводит данные промокода
UI -> ValidationService: Валидирует формат данных
alt Валидация не пройдена (ERR-02)
    ValidationService -> UI: Возвращает ошибки валидации
    UI -> Admin: Подсвечивает поля с ошибками\nи показывает сообщение
    UI -> Admin: Кнопка "Сохранить" остаётся некликабельной
else Валидация пройдена
    UI -> Admin: Кнопка "Сохранить" становится кликабельной
    Admin -> UI: Нажимает кнопку "Сохранить"
    UI -> PromoService: Запрос на создание промокода\n(данные + проверка уникальности)
    
    PromoService -> DB: Проверка существования промокода
    alt Промокод уже существует (ERR-03)
        DB -> PromoService: Возвращает информацию о существующем промокоде
        PromoService -> UI: "Промокод с таким значением уже существует"
        UI -> Admin: Отображает сообщение об ошибке
    else Промокод уникален
        PromoService -> DB: Сохраняет новый промокод
        DB -> PromoService: Подтверждение успешного создания
        PromoService -> UI: Успешный ответ
        UI -> Admin: Отображает уведомление об успешном создании промокода
    end
    
    alt Ошибка сервера (ERR-01) на любом этапе
        UI -> Admin: "Внутренняя ошибка сервиса. Попробуйте позже"
        UI -> UI: Сохраняет введённые данные в форме
    end
end

== Удаление промокода ==

Admin -> UI: Нажимает кнопку удаления промокода\n(рядом с конкретным промокодом)
UI -> PromoService: Запрос на удаление промокода

PromoService -> DB: Удаляет промокод
alt Ошибка сервера (ERR-01)
    DB -> PromoService: Возвращает ошибку
    PromoService -> UI: "Внутренняя ошибка сервиса. Попробуйте позже"
    UI -> Admin: Отображает сообщение об ошибке
else Успешное удаление
    DB -> PromoService: Подтверждение удаления
    PromoService -> UI: Успешный ответ
    UI -> Admin: Отображает уведомление об успешном удалении промокода
end

@enduml