@startuml
title Диаграмма последовательности: Работа с корзиной
actor Пользователь as User
participant "UI (МП)" as UI
participant "Сервис корзины" as CartService
participant "Сервис календаря" as CalendarService
participant "Сервис расчёта" as CalculationService
participant "Сервис промокодов" as PromoService
participant "Сервис экспорта" as ExportService
participant "База данных" as DB

== Открытие корзины и просмотр содержимого ==

User -> UI: Нажимает на вкладку "Корзина"
UI -> User: Открывает модальное окно поверх главной страницы

UI -> CartService: Запрос содержимого корзины пользователя
CartService -> DB: Получение товаров в корзине
DB -> CartService: Возвращает список товаров с количеством
CartService -> UI: Передаёт данные корзины

UI -> UI: Отображает форму корзины с элементами

== Выбор периода аренды (календарь) ==

User -> UI: Нажимает на календарь выбора дат
UI -> CalendarService: Запрос текущего месяца и настроек календаря
CalendarService -> UI: Возвращает данные календаря
UI -> User: Отображает календарь с текущей датой и полями времени

User -> UI: Выбирает начальную дату
UI -> User: Окрашивает дату в зелёный как начало аренды
User -> UI: Выбирает конечную дату
UI -> User: Окрашивает диапазон как период аренды
User -> UI: Вводит время начала и окончания
UI -> UI: Сохраняет выбранный период

alt Повторное открытие календаря (LOC-02)
    User -> UI: Повторно нажимает на календарь
    UI -> UI: Отображает ранее выбранный диапазон\nи позволяет его изменить
end

alt Закрытие календаря кликом вне формы (LOC-01)
    User -> UI: Кликает вне области календаря
    UI -> UI: Закрывает календарь и сохраняет выбранный период
end

UI -> User: После выбора периода активирует кнопку "Рассчитать"\n(если в корзине есть товары)

== Изменение количества позиций ==

User -> UI: Нажимает "+" у товара в корзине
UI -> CartService: Запрос на увеличение количества
CartService -> DB: Увеличивает количество товара на 1
DB -> CartService: Подтверждение обновления
CartService -> UI: Новое количество товара
UI -> User: Обновляет отображение количества и общей стоимости

alt Пользователь нажимает "-" у товара (UC-BT-4)
    User -> UI: Нажимает "-" у товара
    UI -> CartService: Запрос на уменьшение количества
    CartService -> DB: Уменьшает количество товара на 1
    DB -> CartService: Возвращает новое количество
    
    alt Количество стало 0 (LOC-04) - удаление товара
        CartService -> DB: Удаляет товар из корзины
        DB -> CartService: Подтверждение удаления
        CartService -> UI: Товар удалён из корзины
    end
end

== Расчёт стоимости аренды ==

User -> UI: Нажимает кнопку "Рассчитать"
UI -> CalculationService: Запрос расчёта стоимости

CalculationService -> CalculationService: Рассчитывает стоимость для каждого товара\nс учётом выбранного тарифа и периода
CalculationService -> PromoService: Запрос на применение промокода (если есть)

alt Промокод применён
    PromoService -> DB: Проверка валидности промокода
    DB -> PromoService: Данные промокода (скидка %)
    PromoService -> CalculationService: Размер скидки
    CalculationService -> CalculationService: Применяет скидку к итоговой сумме
end

CalculationService -> UI: Возвращает результаты расчёта

UI -> UI: Отображает итоговую стоимость и делает кнопку "Экспорт" кликабельной

== Экспорт сметы ==

User -> UI: Нажимает кнопку "Экспорт"
UI -> ExportService: Запрос на экспорт сметы с данными

ExportService -> ExportService: Формирует файл сметы
ExportService -> UI: Возвращает файл для скачивания
UI -> User: Предлагает скачать файл сметы

== Обработка ошибок ==

alt Ошибка сервера (ERR-01) при любом запросе
    UI -> User: "Внутренняя ошибка сервиса. Попробуйте позже"
    UI -> UI: Откатывает последнее действие\nи сохраняет предыдущее состояние
end

alt Корзина пуста при открытии
    UI -> UI: Отображает сообщение "Корзина пуста"\nи предлагает перейти в каталог
end

@enduml